<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BINGO!</title>
    <link href="" rel="stylesheet">
</head>
<body class="bg-black text-white">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title> Bingo!</title>
    <link rel="stylesheet" href="=">
    <link rel="preload" as="style" href=""><link rel="stylesheet" href="" data-navigate-track="reload">
    <style>
        .winning-pattern-images {
            position: relative;
            max-width: 100%;
        }

        .winning-pattern-images .slide {
            position: absolute;
            width: 100%;
            top: 0;
            left: 0;
        }

        .bingo-card-table {
            width: 90%;
            /* Full width of the container */
            border-collapse: collapse;
            /* Collapses the border between cells */
            margin-top: 20px;
            /* Space above the table */
            background-color: #f8f9fa;
            /* Light grey background */
            align-items: center;
            margin-left: 100px;
            height: 90%;
            /* background-color: #007bff */
            font-size: 60px;
            font-weight: bold;
        }

        .bingo-card-table th {
            background-color: #007bff;
            /* Blue background for headers */
            color: white;
            /* White text color */
            font-weight: bold;
            /* Bold font for headers */
            padding: 12px;
            /* Padding inside the header cells */
            border: 1px solid #dee2e6;
            /* Light grey border */
        }

        .bingo-card-table td {
            text-align: center;
            /* Center-align text */
            padding: 10px;
            /* Padding inside cells */
            border: 1px solid #dee2e6;
            /* Light grey border */
            background-color: #ffffff;
            /* White background for cells */
            color: black;
        }

        #bkg {
            background-color: #899dbe
        }

        .message {
            text-align: center;
            font-size: 30px;
            font-weight: bold;
            background-color: #ddd
        }

        .bingo-card-table tbody tr:nth-child(even) {
            background-color: #f2f2f2;
            /* Zebra striping for rows */
        }

        .bingo-card-table tbody tr:hover {
            background-color: #ddd;
            /* Hover effect for rows */
        }

        .bingo-card-table td.called,
        .bingo-card-table td.center-spot {
            background-color: #007bff;
            /* Blue background for called numbers and the center spot */
            color: white;
            /* White text for better visibility */
        }

        .flex-container {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
        }

        .last-five-calls {
            flex: 1;
            margin-right: 20px;
        }

        .control-panel-group {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-right: 30px;
        }

        .display-panel {
            display: flex;
            flex-direction: column;
        }

        .buttons {
            display: flex;
            flex-direction: column;
            margin-left: 20px;
        }

        .bingo-pattern {
            background-color: #232223;
            width: 270px;
            height: 270px;
            max-width: 300px;
            border-collapse: collapse;
            margin: 0 auto;
        }

        .bingo-pattern th,
        .bingo-pattern td {
            width: 2rem;
            height: 2rem;
            text-align: center;
            border: 5px solid #044472;
        }

        .bingo-pattern .circle {
            width: 1.8rem;
            height: 1.8rem;
            background-color: #019DD6;
            border-radius: 50%;
            margin: 0 auto;
        }

        .bingo-pattern .free-spot {
            background-color: rgb(241, 241, 96);
            width: 1.5rem;
            height: 1.5rem;
            border-radius: 50%;
            margin: 0 auto;
        }

        .winning-amount {
            margin-top: 40px;
        }

        .bingo-pattern-header th {
            background-color: #044472;
            color: white;
            font-weight: bold;
        }

        .bingo-pattern-header th:nth-child(1),
        .bingo-pattern-header th:nth-child(2),
        .bingo-pattern-header th:nth-child(3),
        .bingo-pattern-header th:nth-child(4),
        .bingo-pattern-header th:nth-child(5) {
            background-color: #044472;
        }

        @media (max-width: 768px) {

            .bingo-pattern th,
            .bingo-pattern td {
                width: 1.5rem;
                height: 1.5rem;
                border: 3px solid #044472;
            }

            .bingo-pattern .circle {
                width: 1.8rem;
                height: 1.2rem;
            }

            .bingo-pattern .free-spot {
                width: 1.2rem;
                height: 1.2rem;
            }
        }

        @media (max-width: 480px) {

            .bingo-pattern th,
            .bingo-pattern td {
                width: 1.2rem;
                height: 1.2rem;
                border: 2px solid #044472;
            }

            .bingo-pattern .circle,
            .bingo-pattern .free-spot {
                width: 1rem;
                height: 1rem;
            }
        }
    </style>

    


    <div class="main-container" style="background-color: #232223">

        <table class="bingo-table">
            <tbody>
                                                    <tr>
                        <th>B</th>
                                                    <td>
                                <button class="">
                                    1
                                </button>
                            </td>
                                                    <td>
                                <button class="">
                                    2
                                </button>
                            </td>
                                                    <td>
                                <button class="">
                                    3
                                </button>
                            </td>
                                                    <td>
                                <button class="">
                                    4
                                </button>
                            </td>
                                                    <td>
                                <button class="">
                                    5
                                </button>
                            </td>
                                                    <td>
                                <button class="">
                                    6
                                </button>
                            </td>
                                                    <td>
                                <button class="">
                                    7
                                </button>
                            </td>
                                                    <td>
                                <button class="">
                                    8
                                </button>
                            </td>
                                                    <td>
                                <button class="">
                                    9
                                </button>
                            </td>
                                                    <td>
                                <button class="">
                                    10
                                </button>
                            </td>
                                                    <td>
                                <button class="">
                                    11
                                </button>
                            </td>
                                                    <td>
                                <button class="">
                                    12
                                </button>
                            </td>
                                                    <td>
                                <button class="">
                                    13
                                </button>
                            </td>
                                                    <td>
                                <button class="">
                                    14
                                </button>
                            </td>
                                                    <td>
                                <button class="">
                                    15
                                </button>
                            </td>
                                            </tr>
                                    <tr>
                        <th>I</th>
                                                    <td>
                                <button class="">
                                    16
                                </button>
                            </td>
                                                    <td>
                                <button class="">
                                    17
                                </button>
                            </td>
                                                    <td>
                                <button class="">
                                    18
                                </button>
                            </td>
                                                    <td>
                                <button class="">
                                    19
                                </button>
                            </td>
                                                    <td>
                                <button class="">
                                    20
                                </button>
                            </td>
                                                    <td>
                                <button class="">
                                    21
                                </button>
                            </td>
                                                    <td>
                                <button class="">
                                    22
                                </button>
                            </td>
                                                    <td>
                                <button class="">
                                    23
                                </button>
                            </td>
                                                    <td>
                                <button class="">
                                    24
                                </button>
                            </td>
                                                    <td>
                                <button class="">
                                    25
                                </button>
                            </td>
                                                    <td>
                                <button class="">
                                    26
                                </button>
                            </td>
                                                    <td>
                                <button class="">
                                    27
                                </button>
                            </td>
                                                    <td>
                                <button class="">
                                    28
                                </button>
                            </td>
                                                    <td>
                                <button class="">
                                    29
                                </button>
                            </td>
                                                    <td>
                                <button class="">
                                    30
                                </button>
                            </td>
                                            </tr>
                                    <tr>
                        <th>N</th>
                                                    <td>
                                <button class="">
                                    31
                                </button>
                            </td>
                                                    <td>
                                <button class="">
                                    32
                                </button>
                            </td>
                                                    <td>
                                <button class="">
                                    33
                                </button>
                            </td>
                                                    <td>
                                <button class="">
                                    34
                                </button>
                            </td>
                                                    <td>
                                <button class="">
                                    35
                                </button>
                            </td>
                                                    <td>
                                <button class="">
                                    36
                                </button>
                            </td>
                                                    <td>
                                <button class="">
                                    37
                                </button>
                            </td>
                                                    <td>
                                <button class="">
                                    38
                                </button>
                            </td>
                                                    <td>
                                <button class="">
                                    39
                                </button>
                            </td>
                                                    <td>
                                <button class="">
                                    40
                                </button>
                            </td>
                                                    <td>
                                <button class="">
                                    41
                                </button>
                            </td>
                                                    <td>
                                <button class="">
                                    42
                                </button>
                            </td>
                                                    <td>
                                <button class="">
                                    43
                                </button>
                            </td>
                                                    <td>
                                <button class="">
                                    44
                                </button>
                            </td>
                                                    <td>
                                <button class="">
                                    45
                                </button>
                            </td>
                                            </tr>
                                    <tr>
                        <th>G</th>
                                                    <td>
                                <button class="">
                                    46
                                </button>
                            </td>
                                                    <td>
                                <button class="">
                                    47
                                </button>
                            </td>
                                                    <td>
                                <button class="">
                                    48
                                </button>
                            </td>
                                                    <td>
                                <button class="">
                                    49
                                </button>
                            </td>
                                                    <td>
                                <button class="">
                                    50
                                </button>
                            </td>
                                                    <td>
                                <button class="">
                                    51
                                </button>
                            </td>
                                                    <td>
                                <button class="">
                                    52
                                </button>
                            </td>
                                                    <td>
                                <button class="">
                                    53
                                </button>
                            </td>
                                                    <td>
                                <button class="">
                                    54
                                </button>
                            </td>
                                                    <td>
                                <button class="">
                                    55
                                </button>
                            </td>
                                                    <td>
                                <button class="">
                                    56
                                </button>
                            </td>
                                                    <td>
                                <button class="">
                                    57
                                </button>
                            </td>
                                                    <td>
                                <button class="">
                                    58
                                </button>
                            </td>
                                                    <td>
                                <button class="">
                                    59
                                </button>
                            </td>
                                                    <td>
                                <button class="">
                                    60
                                </button>
                            </td>
                                            </tr>
                                    <tr>
                        <th>O</th>
                                                    <td>
                                <button class="">
                                    61
                                </button>
                            </td>
                                                    <td>
                                <button class="">
                                    62
                                </button>
                            </td>
                                                    <td>
                                <button class="">
                                    63
                                </button>
                            </td>
                                                    <td>
                                <button class="">
                                    64
                                </button>
                            </td>
                                                    <td>
                                <button class="">
                                    65
                                </button>
                            </td>
                                                    <td>
                                <button class="">
                                    66
                                </button>
                            </td>
                                                    <td>
                                <button class="">
                                    67
                                </button>
                            </td>
                                                    <td>
                                <button class="">
                                    68
                                </button>
                            </td>
                                                    <td>
                                <button class="">
                                    69
                                </button>
                            </td>
                                                    <td>
                                <button class="">
                                    70
                                </button>
                            </td>
                                                    <td>
                                <button class="">
                                    71
                                </button>
                            </td>
                                                    <td>
                                <button class="">
                                    72
                                </button>
                            </td>
                                                    <td>
                                <button class="">
                                    73
                                </button>
                            </td>
                                                    <td>
                                <button class="">
                                    74
                                </button>
                            </td>
                                                    <td>
                                <button class="">
                                    75
                                </button>
                            </td>
                                            </tr>
                            </tbody>
        </table>

        <div class="control-panel">
            
            <div class="winning-patterns">
                <div id="slideshow-container" class="winning-pattern-images">
                                                            <img src="" class="slide" style="display: none;" alt="Winning Pattern Image">
                                                            <img src="" class="slide" style="display: none;" alt="Winning Pattern Image">
                                                            <img src="" class="slide" style="display: none;" alt="Winning Pattern Image">
                                                            <img src="" class="slide" style="display: none;" alt="Winning Pattern Image">
                                                            <img src="" class="slide" style="display: none;" alt="Winning Pattern Image">
                                                            <img src="" class="slide" style="display: none;" alt="Winning Pattern Image">
                                                            <img src="" class="slide" style="display: none;" alt="Winning Pattern Image">
                                                            <img src="" class="slide" style="display: none;" alt="Winning Pattern Image">
                                                            <img src="" class="slide" style="display: none;" alt="Winning Pattern Image">
                                                            <img src="" class="slide" style="display: none;" alt="Winning Pattern Image">
                                                            <img src="" class="slide" style="display: none;" alt="Winning Pattern Image">
                                                            <img src="" class="slide" style="display: none;" alt="Winning Pattern Image">
                                                            <img src="" class="slide" style="display: block;" alt="Winning Pattern Image">
                                                            <img src="" class="slide" style="display: none;" alt="Winning Pattern Image">
                                                    </div><table class="bingo-pattern">
                    <thead class="bingo-pattern-header">
                        <tr>
                            <th class="B">B</th>
                            <th class="I">I</th>
                            <th class="N">N</th>
                            <th class="G">G</th>
                            <th class="O">O</th>
                        </tr>
                    </thead>
                    <tbody>

                        

                    </tbody>
                </table>
            </div>

            <div class="display-panel">
                <div class="winning-amount-box">
                    <span class="winning-amharic">ደራሽ</span>
                    <div class="display-winning">40</div>
                </div>
            </div>

        </div>
    </div>

    <!-- Add last five calls display below the table -->
    <div class="flex-container" style="background-color: #232223">
        <div class="last-five-calls">
                                </div>

        <div class="control-panel-group">
            <span class="bottom-right">
                <div class="control-panel">
                    <div class="display-panel">
                        <div class="countdown">
                            <span>Next call</span>
                            <div id="countdown-display" class="display">3s</div>
                        </div>
                        <div class="total-calls">
                            <span>Total Calls</span>
                            <div name="total_calls" class="display">0</div>
                        </div>
                    </div>
                </div>
            </span>
            <div class="buttons">
                
                <form action="bingo.html/check" method="POST">
                    <input type="hidden" name="_token" value="JffMyofHtFqG4L9AG781QxX1bvg53U1dvbuIgTyG" autocomplete="off">                    <div class="input-group">
                        <input type="text" id="cardId" name="card_id" placeholder="Check Board" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg block w-full p-2.5 placeholder-gray-400" required="">
                        <button type="submit" class="btn-check">Check</button>
                    </div>
                </form>


                <!-- Modal Structure -->
                

                <!-- Modal Toggle Script -->
                <script>
                    function toggleModal() {
                        var modal = document.getElementById('check-number');
                        modal.classList.toggle('hidden');
                    }
                </script>


                
                <audio id="pauseAudio" src="audios/Bingo.mp3" preload="auto"></audio>
                <audio id="startAudio" src="audios/Start.mp3" preload="auto"></audio>


                <form action="callern.html" method="POST" id="call-form">
                    <input type="hidden" name="_token" value="JffMyofHtFqG4L9AG781QxX1bvg53U1dvbuIgTyG" autocomplete="off">                    
                    <button type="submit" class="btn-start" id="next-number-btn" 1="">Start
                        Calling</button>
                </form>
                <div class="button-container">
                    <button id="shuffleButton" class="btn-shuffle">Shuffle</button>
                    <form action="bingo.html/end" method="POST" id="end-game-form">
                        <input type="hidden" name="_token" value="JffMyofHtFqG4L9AG781QxX1bvg53U1dvbuIgTyG" autocomplete="off">                       
                        <button type="button" class="btn-end" onclick="confirmEndGame()">End Game</button>
                    </form>
                </div>



            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            let callSpeed = 3000;
            let countdown = callSpeed / 1000;
            let intervalId;
            let isRunning = false;
            let totalCalls = 0; // Fetch total calls from the server-side
            let isFetching = false; // Flag to indicate if a number fetch is in progress


            const nextNumberBtn = document.getElementById('next-number-btn');
            const countdownDisplay = document.getElementById('countdown-display');
            const shuffleButton = document.getElementById('shuffleButton');
            const shuffleSound = new Audio('audios/Shuffle.mp3');
            const slides = document.querySelectorAll('#slideshow-container .slide');
            const numberButtons = document.querySelectorAll('.bingo-table td button');
            const pauseAudio = document.getElementById('pauseAudio');
            const startAudio = document.getElementById('startAudio');
            const gameSetup = {"bet_amount":"10","winning_pattern":"1","call_speed":"very_fast","caller_language":"amharic_female_3sec"};
            // console.log(gameSetup);
            let activeInterval;

            let numberActivationCounts = new Map(); // To track activations for each number
            let totalActivationsNeeded = 10; // Each number needs to be active twice


            let currentSlide = 0;

            function showSlide(index) {
                slides.forEach((slide, i) => {
                    slide.style.display = (i === index) ? 'block' : 'none';
                });
            }

            function nextSlide() {
                currentSlide = (currentSlide + 1) % slides.length;
                showSlide(currentSlide);
            }

            showSlide(currentSlide);
            setInterval(nextSlide, 3000);

            window.addEventListener('DOMContentLoaded', (event) => {
                const successAudio = document.getElementById('success-audio');
                const failAudio = document.getElementById('fail-audio');

                if (successAudio) {
                    successAudio.play();
                } else if (failAudio) {
                    failAudio.play();
                }
            });

            // Close modal on clicking outside of the modal content
            window.onclick = function(event) {
                if (event.target == document.getElementById('check-number')) {
                    closeModal();
                }
            };

            document.addEventListener('keydown', function(event) {
                if (event.key === "Escape") { // Check if the key pressed is 'Escape'
                    closeModal();
                }
            });

            function closeModal() {
                document.getElementById('check-number').style.display = "none";
            }



            window.confirmEndGame = function() {
                var response = confirm('Are you sure you want to end the game?');
                if (response) {
                    document.getElementById('end-game-form').submit();
                } else {
                    console.log('Game end canceled by user.');
                }
            }


            function shuffleActiveNumbers() {
                // Reset the active class for all buttons at the start of each shuffle
                numberButtons.forEach(button => {
                    button.classList.remove('active');
                });

                const activeCount = 25 + Math.floor(Math.random() * 6); // Randomly choose between 5 to 10 numbers
                const shuffledNumbers = Array.from(numberButtons);
                shuffleArray(shuffledNumbers);

                shuffledNumbers.slice(0, activeCount).forEach(button => {
                    button.classList.add('active');
                    let activations = numberActivationCounts.get(button.textContent) || 0;
                    numberActivationCounts.set(button.textContent, ++
                        activations); // Increment the activation count
                });

                // Check if all numbers have been activated at least twice
                if (Array.from(numberActivationCounts.values()).every(count => count >= totalActivationsNeeded)) {
                    clearInterval(activeInterval); // Stop the interval when all numbers have been activated twice
                    console.log('All numbers have been activated twice.');
                    numberButtons.forEach(button => {
                        button.classList.remove('active');
                    });
                }
            }

            shuffleButton.addEventListener('click', function() {
                shuffleSound.play();
                clearInterval(activeInterval); // Clear any existing interval
                numberActivationCounts.clear(); // Reset activation counts
                shuffleActiveNumbers(); // Initial shuffle when button is clicked
                activeInterval = setInterval(shuffleActiveNumbers,
                    75); // Shuffle active numbers every 2 seconds
            });

            function shuffleArray(array) {
                for (let i = array.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [array[i], array[j]] = [array[j], array[i]]; // Swap elements
                }
            }

            function startCalling() {
                if (!intervalId) { // Ensure that no interval is running before starting a new one
                    startAudio.play(); // Play start sound

                    startAudio.onended = function() { // When the start sound ends, start the countdown
                        intervalId = setInterval(() => {
                            if (totalCalls >= 75) {
                                pauseCalling();
                                alert('Maximum number of calls reached.');
                                return;
                            }
                            if (countdown > 0) {
                                countdown -= 1;
                                countdownDisplay.textContent = `${countdown}s`;
                            }
                            if (countdown <= 0 && !
                                isFetching) { // Only fetch next number if not already fetching
                                fetchNextNumber();
                            }
                        }, 1000);
                        isRunning = true;
                        nextNumberBtn.textContent = 'Pause';
                    };
                }
            }

            function pauseCalling() {
                if (intervalId) {
                    pauseAudio.play(); // Play pause sound
                    clearInterval(intervalId);
                    intervalId = null; // Clear the interval ID
                }
                isRunning = false;
                nextNumberBtn.textContent = 'Start';
            }

            function resetCountdown() {
                countdown = callSpeed / 1000;
                countdownDisplay.textContent = `${countdown}s`;
            }

            nextNumberBtn.addEventListener('click', function(event) {
                event.preventDefault();
                if (isRunning) {
                    pauseCalling();
                } else {
                    startCalling();
                }
            });

            document.addEventListener('keydown', function(event) {
                if (event.code === 'Space') {
                    event.preventDefault();
                    if (isRunning) {
                        pauseCalling();
                    } else {
                        startCalling();
                    }
                }
            });

            async function fetchNextNumber() {
                if (!isFetching) {
                    isFetching = true; // Set flag to true to indicate fetch in progress
                    const response = await fetch("bingo.html/call", {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRF-TOKEN': 'JffMyofHtFqG4L9AG781QxX1bvg53U1dvbuIgTyG'
                        }
                    });
                    const data = await response.json();
                    const newNumber = data.number;
                    totalCalls = data.totalCalls;
                    updateBoard(data.callHistory);
                    updateCallDisplay(data.callHistory);

                    if (data.number !== null) {
                        let callerLanguage = gameSetup.caller_language || 'amharic_female';
                        let audioPath = `/audios/${callerLanguage}/${data.number}.mp3`;
                        let audio = new Audio(audioPath);

                        audio.play().catch(e => {
                            console.error('Error playing audio:', e);
                            callerLanguage = 'amharic_female';
                            audioPath =
                                `/audios/${callerLanguage}/${data.number}.mp3`;
                            audio = new Audio(
                                audioPath);
                            audio.play().catch(error => {
                                console.error('Error playing fallback audio:',
                                    error);
                            });
                        });
                    }

                    resetCountdown(); // Reset the countdown after fetching the number
                    isFetching = false; // Reset flag after fetch completes
                }
            }

            function updateBoard(callHistory) {
                const bingoButtons = document.querySelectorAll('.bingo-table button');
                const totalCallsDisplay = document.querySelector('.total-calls .display');
                if (totalCallsDisplay) {
                    totalCallsDisplay.textContent = totalCalls;
                }

                // Update previous calls display
                const countdownDisplay = document.querySelector('.countdown .display');
                // if (countdownDisplay && callHistory.length) {
                //     countdownDisplay.textContent = callHistory[callHistory.length - 1];
                // }
                bingoButtons.forEach(button => {
                    const number = parseInt(button.textContent, 10);
                    if (callHistory.includes(number)) {
                        button.classList.add('called');
                    } else {
                        button.classList.remove('called');
                    }
                });
            }

            function updateCallDisplay(callHistory) {
                const previousNumbersContainer = document.querySelector('.last-five-calls');
                if (!previousNumbersContainer) {
                    console.error("Last five calls container not found");
                    return;
                }
                // Clear only the calls, not the entire display
                previousNumbersContainer.innerHTML = '';

                callHistory.slice(-6).reverse().forEach((number, index) => {
                    const letter = getLetterForNumber(number);
                    const colorClass = `ball-${getColorForLetter(letter)}`;
                    const isCurrentCall = index === 0; // First element is the current call

                    const callDiv = document.createElement('div');
                    callDiv.className =
                        `previous-number ${colorClass} ${isCurrentCall ? 'current-call' : ''}`;
                    callDiv.innerHTML = `<span>${letter}<br>${number}</span>`;
                    previousNumbersContainer.appendChild(callDiv);
                });
            }

            // Make sure this function accurately reflects your bingo logic
            function getLetterForNumber(number) {
                if (number <= 15) return 'B';
                if (number <= 30) return 'I';
                if (number <= 45) return 'N';
                if (number <= 60) return 'G';
                if (number <= 75) return 'O';
                return '?';
            }

            function getColorForLetter(letter) {
                const colors = {
                    'B': 'blue',
                    'I': 'red',
                    'N': 'orange',
                    'G': 'green',
                    'O': 'yellow',
                };
                return colors[letter] || 'default';
            }


            resetCountdown();
        });
    </script>






</body>
</html>
